<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agendei Pro - Gestão Profissional</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        :root { 
            --primary: #7b5ea7; --secondary: #fdf4ff; --accent: #ff6b81; --edit: #4a90e2;
            --bg: linear-gradient(135deg, #f8e8ee, #e3f2fd); --text: #333; --card-bg: #ffffff;
        }
        body.dark-mode { --bg: #1a1a2e; --text: #e0e0e0; --card-bg: #16213e; --secondary: #0f3460; }
        body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; display: flex; flex-direction: column; align-items: center; padding: 20px; transition: 0.3s; }
        .container { background: var(--card-bg); width: 100%; max-width: 500px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); box-sizing: border-box; }
        .nav-tabs { display: flex; justify-content: space-around; margin-bottom: 25px; border-bottom: 2px solid #eee; }
        .tab-item { padding: 10px; cursor: pointer; font-weight: 600; color: #999; }
        .tab-item.active { color: var(--primary); border-bottom: 3px solid var(--primary); }
        .content-section { display: none; }
        .content-section.active { display: block; }
        h1, h2, h3 { text-align: center; color: var(--primary); margin: 10px 0; }
        label { font-size: 13px; font-weight: 600; display: block; margin-top: 15px; }
        input, select, textarea, button { width: 100%; padding: 12px; margin-top: 6px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; font-family: inherit; }
        button { background-color: var(--primary); color: white; border: none; font-weight: 600; cursor: pointer; margin-top: 15px; }
        .card { background: var(--secondary); padding: 15px; border-radius: 12px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .actions { display: flex; gap: 8px; }
        .btn-mini { width: auto; font-size: 10px; padding: 8px; margin: 0; border-radius: 8px; }
        .btn-edit { background: var(--edit); }
        .btn-del { background: var(--accent); }
        .checkbox-group { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
        .checkbox-item { background: var(--secondary); padding: 12px; border-radius: 8px; display: flex; align-items: center; gap: 10px; font-size: 14px; }
        .checkbox-item input { width: 22px; height: 22px; margin: 0; }
        .grid-half { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        hr { border: 0; border-top: 1px solid #eee; margin: 25px 0; }
        .footer { text-align: center; font-size: 11px; margin-top: 20px; color: #999; }
    </style>
</head>
<body id="body">

<div class="container">
    <div class="nav-tabs">
        <div class="tab-item active" id="tab-agendar">Agendar</div>
        <div class="tab-item" id="tab-dashboard">Agenda</div>
        <div class="tab-item" id="tab-config">Ajustes</div>
    </div>

    <div id="sec-agendar" class="content-section active">
        <h1 id="display-nome-espaco">Meu Espaço</h1>
        <label>Serviço</label>
        <select id="select-servico-agendar"><option value="">Carregando...</option></select>
        <label>Profissional</label>
        <select id="select-profissional-agendar"><option value="">Selecione o serviço primeiro...</option></select>
        <label>Nome da Cliente</label>
        <input type="text" id="nome-cliente">
        <label>WhatsApp</label>
        <input type="text" id="tel-cliente" placeholder="DDD + Número">
        <div class="grid-half">
            <div><label>Data</label><input type="date" id="data-ag"></div>
            <div><label>Hora</label><input type="time" id="hora-ag"></div>
        </div>
        <button id="btn-finalizar-ag">Confirmar Agendamento</button>
    </div>

    <div id="sec-dashboard" class="content-section">
        <h2>Agenda do Dia</h2>
        <input type="date" id="data-filtro-ver">
        <div id="lista-hoje" style="margin-top: 15px;"></div>
    </div>

    <div id="sec-config" class="content-section">
        <h2>Configurações</h2>
        <button id="btn-dark" style="background: #333; margin-bottom: 10px;">Modo Noturno</button>
        
        <label>Nome do Estabelecimento</label>
        <div class="grid-half" style="grid-template-columns: 2fr 1fr;">
            <input type="text" id="input-nome-espaco">
            <button id="btn-save-nome" style="margin-top: 6px;">OK</button>
        </div>

        <hr>
        <h3 id="titulo-servico">Cadastrar Serviço</h3>
        <input type="hidden" id="edit-servico-id">
        <input type="text" id="s-nome" placeholder="Nome do Serviço">
        <div class="grid-half">
            <input type="number" id="s-tempo" placeholder="Tempo (min)">
            <input type="number" id="s-preco" placeholder="Preço R$">
        </div>
        <label>Profissionais habilitados:</label>
        <div id="checks-profs" class="checkbox-group"></div>
        <button id="btn-save-servico" style="background: #2ecc71;">Salvar Serviço</button>
        <div id="lista-servicos-ajustes" style="margin-top: 15px;"></div>

        <hr>
        <h3 id="titulo-equipe">Equipe</h3>
        <input type="hidden" id="edit-prof-id">
        <div class="grid-half" style="grid-template-columns: 2fr 1fr;">
            <input type="text" id="p-nome" placeholder="Nome do Profissional">
            <button id="btn-save-prof">Salvar</button>
        </div>
        <div id="lista-profs-ajustes" style="margin-top: 15px;"></div>
    </div>

    <div class="footer">Sistema Versão 1.0 Pro</div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, where, doc, deleteDoc, getDocs, setDoc, getDoc, orderBy } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAxyovmqjNYIzOYYDZZnduquiJQeK4UIgc",
        authDomain: "agendei-d721e.firebaseapp.com",
        projectId: "agendei-d721e",
        storageBucket: "agendei-d721e.firebasestorage.app",
        messagingSenderId: "525023801595",
        appId: "1:525023801595:web:71a6d72e986e6e9e30005e"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- ELEMENTOS E ESTADOS ---
    const colProfs = collection(db, "profissionais");
    const colServs = collection(db, "servicos");
    const colAgend = collection(db, "agendamentos");

    // --- CARREGAMENTO INICIAL ---
    onSnapshot(colProfs, (snap) => {
        const listaAjustes = document.getElementById('lista-profs-ajustes');
        const checks = document.getElementById('checks-profs');
        listaAjustes.innerHTML = ""; checks.innerHTML = "";
        snap.forEach(d => {
            const p = d.data();
            listaAjustes.innerHTML += `<div class="card"><span>${p.nome}</span><div class="actions">
                <button class="btn-mini btn-edit" onclick="editarProf('${d.id}', '${p.nome}')">✎</button>
                <button class="btn-mini btn-del" onclick="removerDoc('profissionais', '${d.id}')">X</button>
            </div></div>`;
            checks.innerHTML += `<div class="checkbox-item"><input type="checkbox" name="p-check" value="${p.nome}"> ${p.nome}</div>`;
        });
    });

    onSnapshot(colServs, (snap) => {
        const listaAjustes = document.getElementById('lista-servicos-ajustes');
        const selectAg = document.getElementById('select-servico-agendar');
        listaAjustes.innerHTML = ""; 
        selectAg.innerHTML = '<option value="">Escolha um serviço...</option>';
        snap.forEach(d => {
            const s = d.data();
            listaAjustes.innerHTML += `<div class="card"><span>${s.nome} <br><small>R$ ${s.preco} - ${s.tempo}min</small></span><div class="actions">
                <button class="btn-mini btn-edit" onclick="editarServico('${d.id}')">✎</button>
                <button class="btn-mini btn-del" onclick="removerDoc('servicos', '${d.id}')">X</button>
            </div></div>`;
            selectAg.innerHTML += `<option value="${d.id}">${s.nome}</option>`;
        });
    });

    // --- LÓGICA DE EDIÇÃO ---
    window.editarProf = (id, nome) => {
        document.getElementById('edit-prof-id').value = id;
        document.getElementById('p-nome').value = nome;
        document.getElementById('titulo-equipe').innerText = "Editando Profissional";
    };

    window.editarServico = async (id) => {
        const d = await getDoc(doc(db, "servicos", id));
        const s = d.data();
        document.getElementById('edit-servico-id').value = id;
        document.getElementById('s-nome').value = s.nome;
        document.getElementById('s-tempo').value = s.tempo;
        document.getElementById('s-preco').value = s.preco;
        document.getElementById('titulo-servico').innerText = "Editando Serviço";
        // Marcar checkboxes
        const checks = document.querySelectorAll('input[name="p-check"]');
        checks.forEach(c => c.checked = s.profissionais.includes(c.value));
        window.switchTab('tab-config');
    };

    // --- SALVAMENTO (CREATE OU UPDATE) ---
    document.getElementById('btn-save-prof').onclick = async () => {
        const id = document.getElementById('edit-prof-id').value;
        const nome = document.getElementById('p-nome').value;
        if(!nome) return;
        if(id) await setDoc(doc(db, "profissionais", id), { nome });
        else await addDoc(colProfs, { nome });
        document.getElementById('edit-prof-id').value = "";
        document.getElementById('p-nome').value = "";
        document.getElementById('titulo-equipe').innerText = "Equipe";
    };

    document.getElementById('btn-save-servico').onclick = async () => {
        const id = document.getElementById('edit-servico-id').value;
        const nome = document.getElementById('s-nome').value;
        const tempo = document.getElementById('s-tempo').value;
        const preco = document.getElementById('s-preco').value;
        const selecionados = Array.from(document.querySelectorAll('input[name="p-check"]:checked')).map(c => c.value);
        
        if(!nome || selecionados.length === 0) return alert("Preencha nome e profissionais!");
        
        const dados = { nome, tempo, preco, profissionais: selecionados };
        if(id) await setDoc(doc(db, "servicos", id), dados);
        else await addDoc(colServs, dados);

        alert("Serviço salvo!");
        limparFormServico();
    };

    function limparFormServico() {
        document.getElementById('edit-servico-id').value = "";
        document.getElementById('s-nome').value = "";
        document.getElementById('s-tempo').value = "";
        document.getElementById('s-preco').value = "";
        document.querySelectorAll('input[name="p-check"]').forEach(c => c.checked = false);
        document.getElementById('titulo-servico').innerText = "Cadastrar Serviço";
    }

    // --- VÍNCULO NO AGENDAMENTO (Onde estava bugado) ---
    document.getElementById('select-servico-agendar').onchange = async (e) => {
        const sId = e.target.value;
        const selProf = document.getElementById('select-profissional-agendar');
        selProf.innerHTML = '<option value="">Carregando profissionais...</option>';
        if(!sId) return;
        
        const d = await getDoc(doc(db, "servicos", sId));
        if(d.exists()) {
            const profs = d.data().profissionais;
            selProf.innerHTML = '<option value="">Quem vai atender?</option>';
            profs.forEach(p => selProf.innerHTML += `<option value="${p}">${p}</option>`);
        }
    };

    // --- NAVEGAÇÃO E AUXILIARES ---
    window.switchTab = (id) => {
        const tabs = {'tab-agendar':'sec-agendar', 'tab-dashboard':'sec-dashboard', 'tab-config':'sec-config'};
        document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
        document.querySelectorAll('.tab-item').forEach(t => t.classList.remove('active'));
        document.getElementById(tabs[id]).classList.add('active');
        document.getElementById(id).classList.add('active');
    };
    document.querySelectorAll('.tab-item').forEach(t => t.onclick = () => window.switchTab(t.id));
    
    window.removerDoc = async (colecao, id) => { if(confirm("Excluir definitivamente?")) await deleteDoc(doc(db, colecao, id)); };

    document.getElementById('btn-dark').onclick = () => document.getElementById('body').classList.toggle('dark-mode');

    // NOME DO ESPAÇO
    document.getElementById('btn-save-nome').onclick = async () => {
        const n = document.getElementById('input-nome-espaco').value;
        await setDoc(doc(db, "configuracoes", "geral"), { nome: n });
        document.getElementById('display-nome-espaco').innerText = n;
        alert("Nome atualizado!");
    };
    async function loadNome() {
        const d = await getDoc(doc(db, "configuracoes", "geral"));
        if(d.exists()) {
            document.getElementById('display-nome-espaco').innerText = d.data().nome;
            document.getElementById('input-nome-espaco').value = d.data().nome;
        }
    }
    loadNome();

</script>
</body>
</html>
